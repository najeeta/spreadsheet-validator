# SpreadsheetValidator — AG-UI State-Driven React Cards - Progress Log

## Project Context
- PRD: prd_plan_a.json
- 6 phases, 15 total stories
- TDD approach: RED -> GREEN -> REFACTOR for every story
- Architecture: ADK agents + ag-ui-adk SSE + CopilotKit useCoAgentStateRender + custom React cards

## Completed Stories
- 1.1: Project scaffold with pyproject.toml and directory structure
- 1.2: PipelineState Pydantic model with aligned status values
- 1.3: Agent callbacks: state initialization and prompt injection

## Current Phase
Phase 1 - Project Scaffold & Models (COMPLETE)
Phase 2 - Tools (NEXT)

## Learnings & Patterns
(To be updated as implementation progresses)

## Blockers & Issues
(none yet)

## Quality Gates
- Each story follows TDD: write test first, then implement
- Commit message format: feat|fix|refactor(scope): description
- Backend: ruff check . && ruff format --check .
- Frontend: npm run build && npm run lint
- Coverage: >=80% line coverage for new modules

---

## Iteration Log

### Story 1.1: Project scaffold with pyproject.toml and directory structure
**Completed:** 2026-02-01
**Phase:** 1 - Project Scaffold & Models

**What Was Done:**
- Created pyproject.toml with all required dependencies (google-adk, fastapi, ag-ui-adk, pandas, etc.)
- Set up app/ package with agents/ and tools/ sub-packages
- Created tests/foundation/test_scaffold.py with 5 scaffold verification tests
- Added tests/conftest.py and test __init__.py files
- Created .env.example with GOOGLE_GENAI_USE_VERTEXAI and GOOGLE_API_KEY
- Added [dependency-groups] dev section so `uv sync` installs dev deps by default
- Added [tool.hatch.build.targets.wheel] packages config for hatchling

**Verification:**
- uv sync: PASS (131 packages installed)
- pytest tests/foundation/test_scaffold.py -v: PASS (5 passed)
- ruff check . && ruff format --check .: PASS
- python -c 'import app': PASS
- pytest --co: PASS (5 tests collected)
- All acceptance criteria: Satisfied

**Learnings:**
- Hatchling requires `[tool.hatch.build.targets.wheel] packages = ["app"]` when the package name doesn't match the project name
- `uv sync` without `--all-extras` won't install `[project.optional-dependencies]`, but `[dependency-groups]` are installed by default
- Must use `uv run pytest` (not bare `pytest`) to ensure the virtual env is used

### Story 1.2: PipelineState Pydantic model with aligned status values
**Completed:** 2026-02-01
**Phase:** 1 - Project Scaffold & Models

**What Was Done:**
- Created app/models.py with PipelineState Pydantic model
- 10-value Status Literal: IDLE, UPLOADING, RUNNING, VALIDATING, WAITING_FOR_USER, FIXING, TRANSFORMING, PACKAGING, COMPLETED, FAILED
- All fields with sensible defaults (status="IDLE", empty lists/dicts, validation_complete=False, usd_rounding="cents")
- No ui_events field — Plan A uses state-driven rendering
- Created tests/foundation/test_pipeline_state.py with 23 tests across 3 test classes

**Verification:**
- pytest tests/foundation/test_pipeline_state.py -v: PASS (23 passed)
- pytest tests/ -v: PASS (28 passed, including story 1.1 tests)
- ruff check . && ruff format --check .: PASS
- All acceptance criteria: Satisfied

**Learnings:**
- ruff format adjusts blank line spacing — run `ruff format` before committing to avoid format check failures
- PipelineState uses `list[dict]` and `dict[str, str]` for mutable defaults — Pydantic handles default factory automatically

### Story 1.3: Agent callbacks: state initialization and prompt injection
**Completed:** 2026-02-01
**Phase:** 1 - Project Scaffold & Models

**What Was Done:**
- Created app/callbacks.py with three callback functions
- on_before_agent: idempotent state initialization, fills missing keys with PipelineState defaults using fresh copies for mutable values
- before_model_modifier: injects pipeline state summary into root agent's system instruction only (SpreadsheetValidatorAgent)
- after_model_modifier: no-op that returns None, logs for debugging
- Created tests/agents/test_callbacks.py with 7 tests across 3 test classes
- Created tests/agents/__init__.py

**Verification:**
- pytest tests/agents/test_callbacks.py -v: PASS (7 passed)
- pytest tests/ -v: PASS (35 passed, all stories)
- ruff check . && ruff format --check .: PASS
- All acceptance criteria: Satisfied

**Learnings:**
- Using lambdas for mutable defaults in _STATE_DEFAULTS dict ensures fresh copies on each call
- PropertyMock on type() is needed to mock agent_name as a property on MagicMock
- Phase 1 is now complete — all 3 foundation stories done
