{
  "title": "SpreadsheetValidator \u2014 AG-UI State-Driven React Cards",
  "description": "Build a SpreadsheetValidator agent from the existing validator-agent codebase using CopilotKit's useCoAgentStateRender approach. The agent backend uses Google ADK with ag-ui-adk for SSE streaming. The webapp renders pipeline status cards (ingestion, validation, progress, completion) via custom React components driven by agent state transitions \u2014 no A2UI protocol. This is the simpler, lower-risk approach.",
  "source": "Gap analysis of with-a2a-a2ui reference vs validator-agent \u2014 Plan A",
  "methodology": {
    "approach": "Test-Driven Development (TDD)",
    "process": [
      "1. RED: Write failing tests that define acceptance criteria",
      "2. GREEN: Implement minimum code to make tests pass",
      "3. REFACTOR: Clean up while keeping tests green"
    ],
    "testLayers": {
      "unit": "Python tool tests (pytest), React component tests (vitest + @testing-library/react)",
      "integration": "Agent workflow tests (ADK Runner), server endpoint tests (httpx AsyncClient)",
      "e2e": "Backend server start + upload + validate + download artifact"
    },
    "coverageTargets": {
      "unit": ">=80% line coverage for new Python and TypeScript modules",
      "integration": "All critical paths exercised (ingest, validate, fix, transform, package)",
      "e2e": "Upload-to-download happy path succeeds"
    },
    "framework": "pytest + pytest-asyncio (backend), vitest + @testing-library/react + jsdom (frontend)",
    "testFileConvention": "tests/<layer>/test_<module>.py (backend), src/__tests__/<component>.test.tsx (frontend)",
    "storyExecutionOrder": "For each story: (1) Write test file with failing tests, (2) Run tests to confirm RED, (3) Implement code, (4) Run tests to confirm GREEN, (5) Refactor, (6) Verify"
  },
  "architecturalNotes": {
    "agentFramework": "Google ADK (google-adk>=1.15.0). Root agent orchestrates 3 sub-agents (Ingestion, Validation, Processing). Each sub-agent has dedicated tools that mutate shared session state.",
    "serverArchitecture": "FastAPI server with ag-ui-adk bridge. ADKAgent.from_app() wraps the ADK App. add_adk_fastapi_endpoint() mounts the AG-UI SSE endpoint at /agent. Supplementary REST endpoints for upload, runs, artifacts, health.",
    "frontendArchitecture": "Next.js 16 + React 19 + CopilotKit v2. CopilotRuntime uses HttpAgent pointing to the backend /agent SSE endpoint. useCoAgentStateRender subscribes to agent state changes and renders custom React card components. File upload via /upload REST endpoint with threadId-based session continuity.",
    "stateRendering": "useCoAgentStateRender<AgentState> hook renders cards based on state.status transitions: RUNNING->IngestionSummaryCard, VALIDATING->ValidationResultsCard, TRANSFORMING/PACKAGING->ProgressCard, COMPLETED->CompletionCard. No A2UI protocol, no monkey-patches, no render_a2ui tool. The backend emits state changes naturally through ADK; the frontend subscribes.",
    "sessionContinuity": "Frontend generates threadId (UUID) on mount. Pre-creates backend session via POST /run?thread_id=X. Uploads file to POST /upload?thread_id=X. Passes same threadId to CopilotChat so agent reuses the session. State stored in InMemorySessionService keyed by app_name/user_id/session_id.",
    "statusValues": "IDLE, UPLOADING, RUNNING, VALIDATING, WAITING_FOR_USER, FIXING, TRANSFORMING, PACKAGING, COMPLETED, FAILED. Tools set these directly on state['status']. Frontend PipelineStatus type matches."
  },
  "stories": [
    {
      "id": "1.1",
      "title": "Project scaffold with pyproject.toml and directory structure",
      "phase": 1,
      "depends_on": [],
      "spec": "validator-agent/docs/phases/phase-01-scaffold-models.md#story-1.1",
      "passes": true,
      "description": "Create the project directory structure: validator-agent/app/ with __init__.py, agent.py, models.py, callbacks.py; validator-agent/app/agents/ with __init__.py; validator-agent/app/tools/ with __init__.py; validator-agent/tests/ with conftest.py. Create pyproject.toml with dependencies: google-adk>=1.15.0, fastapi>=0.100.0, uvicorn>=0.20.0, pandas>=2.0.0, openpyxl>=3.1.0, pydantic>=2.0.0, python-dotenv>=1.0.0, ag-ui-protocol>=0.1.10, ag-ui-adk>=0.4.2. Dev dependencies: pytest, pytest-asyncio, pytest-cov, httpx, ruff. Create .env.example with GOOGLE_GENAI_USE_VERTEXAI=FALSE and GOOGLE_API_KEY placeholder.",
      "acceptanceCriteria": [
        "Directory structure exists: app/, app/agents/, app/tools/, tests/",
        "pyproject.toml has all required dependencies",
        "uv sync succeeds without errors",
        "python -c 'import app' succeeds",
        "pytest --co (collect only) finds 0 tests and exits cleanly",
        ".env.example exists with GOOGLE_GENAI_USE_VERTEXAI and GOOGLE_API_KEY"
      ],
      "qualityCheck": "cd validator-agent && uv sync && pytest tests/foundation/test_scaffold.py -v"
    },
    {
      "id": "1.2",
      "title": "PipelineState Pydantic model with aligned status values",
      "phase": 1,
      "depends_on": [
        "1.1"
      ],
      "spec": "validator-agent/docs/phases/phase-01-scaffold-models.md#story-1.2",
      "passes": true,
      "description": "Create app/models.py with PipelineState(BaseModel). Status Literal must include all values that tools and agents actually set: IDLE, UPLOADING, RUNNING, VALIDATING, WAITING_FOR_USER, FIXING, TRANSFORMING, PACKAGING, COMPLETED, FAILED. Fields: status, active_run_id (Optional[str]), file_path (Optional[str]), file_name (Optional[str]), uploaded_file (Optional[str]), dataframe_records (list[dict]), dataframe_columns (list[str]), validation_errors (list[dict]), validation_complete (bool), pending_fixes (list[dict]), artifacts (dict[str,str]), as_of (Optional[str]), usd_rounding (Optional[Literal['cents','whole']]), cost_center_map (dict[str,str]). No ui_events field \u2014 Plan A does not use A2UI events.",
      "acceptanceCriteria": [
        "PipelineState can be instantiated with defaults: PipelineState()",
        "status default is 'IDLE'",
        "Status Literal includes all 10 values: IDLE, UPLOADING, RUNNING, VALIDATING, WAITING_FOR_USER, FIXING, TRANSFORMING, PACKAGING, COMPLETED, FAILED",
        "Setting status='RUNNING' is valid (no Pydantic validation error)",
        "Setting status='FIXING' is valid",
        "dataframe_records defaults to empty list",
        "usd_rounding defaults to 'cents'",
        "No ui_events field exists on the model",
        "Test: PipelineState() returns valid instance with all defaults",
        "Test: PipelineState(status='RUNNING') is valid",
        "Test: PipelineState(status='INVALID') raises ValidationError"
      ],
      "qualityCheck": "cd validator-agent && pytest tests/foundation/test_pipeline_state.py -v"
    },
    {
      "id": "1.3",
      "title": "Agent callbacks: state initialization and prompt injection",
      "phase": 1,
      "depends_on": [
        "1.2"
      ],
      "spec": "validator-agent/docs/phases/phase-01-scaffold-models.md#story-1.3",
      "passes": true,
      "description": "Create app/callbacks.py with three functions. (1) on_before_agent(callback_context): Idempotent state initialization \u2014 for each key in _STATE_DEFAULTS, set value if not present. Use fresh copies for mutable defaults. Log initialized fields. (2) before_model_modifier(callback_context, llm_request): Only modifies root agent. Builds a text summary of current state (status, file_name, row count, column list, error count, pending fixes, artifacts, as_of, usd_rounding). Prepends to system instruction. No A2UI hints. (3) after_model_modifier(callback_context, llm_response): Logs response type for debugging. Does not modify response.",
      "acceptanceCriteria": [
        "on_before_agent initializes all state fields when state is empty",
        "on_before_agent does NOT overwrite existing state values",
        "on_before_agent uses fresh list/dict copies for mutable defaults",
        "before_model_modifier only modifies prompts for SpreadsheetValidatorAgent",
        "before_model_modifier injects state summary into system instruction",
        "State summary includes status, file_name, row count when data is loaded",
        "No A2UI hint is generated or injected",
        "after_model_modifier returns None (no modification)",
        "Test: on_before_agent fills missing keys with defaults",
        "Test: on_before_agent preserves existing values",
        "Test: before_model_modifier injects state summary for root agent",
        "Test: before_model_modifier skips non-root agents"
      ],
      "qualityCheck": "cd validator-agent && pytest tests/agents/test_callbacks.py -v"
    },
    {
      "id": "2.1",
      "title": "Ingestion tools: request_file_upload, ingest_file, ingest_uploaded_file",
      "phase": 2,
      "depends_on": [
        "1.2"
      ],
      "spec": "validator-agent/docs/phases/phase-02-tools.md#story-2.1",
      "passes": true,
      "description": "Create app/tools/ingestion.py. (1) request_file_upload(tool_context) \u2014 returns dict with status='waiting_for_upload', accepted_formats. (2) ingest_file(tool_context, file_path: str) \u2014 reads CSV/XLSX via pandas, sets state: dataframe_records, dataframe_columns, file_path, status='RUNNING'. Returns row_count and columns. (3) async ingest_uploaded_file(tool_context) \u2014 reads state['uploaded_file'], loads artifact via tool_context.load_artifact(), parses with pandas. Sets same state keys. Falls back to xlsx->csv parsing. Export all three from app/tools/__init__.py.",
      "acceptanceCriteria": [
        "request_file_upload returns status='waiting_for_upload' with accepted_formats",
        "ingest_file reads a CSV and populates state with records and columns",
        "ingest_file reads an XLSX and populates state with records and columns",
        "ingest_file sets state['status'] = 'RUNNING'",
        "ingest_file returns error dict for unsupported file types",
        "ingest_uploaded_file loads artifact from tool_context.load_artifact()",
        "ingest_uploaded_file returns error if state has no uploaded_file",
        "ingest_uploaded_file returns error if artifact not found",
        "ingest_uploaded_file sets state['status'] = 'RUNNING'",
        "Test: ingest_file with test CSV returns correct row count and columns",
        "Test: ingest_uploaded_file with mocked artifact returns correct data",
        "Test: ingest_uploaded_file with no uploaded_file returns error"
      ],
      "qualityCheck": "cd validator-agent && pytest tests/tools/test_ingestion.py -v"
    },
    {
      "id": "2.2",
      "title": "Validation tools: validate_data, request_user_fix, write_fix",
      "phase": 2,
      "depends_on": [
        "1.2"
      ],
      "spec": "validator-agent/docs/phases/phase-02-tools.md#story-2.2",
      "passes": true,
      "description": "Create app/tools/validation.py. (1) validate_data(tool_context, as_of_date: Optional[str]) \u2014 validates all records against 7 rules (employee_id regex+unique, dept enum, amount range, currency enum, spend_date format+not-future, vendor non-empty, fx_rate required for non-USD). Populates state['validation_errors'] with [{row_index, row_data, errors: [{field, error}]}]. Sets validation_complete=True, status='VALIDATING'. (2) request_user_fix(tool_context, row_index, field, current_value, error_message) \u2014 appends to state['pending_fixes'], sets status='WAITING_FOR_USER'. (3) write_fix(tool_context, row_index, field, new_value) \u2014 updates record, removes from pending_fixes, sets status='RUNNING' when empty.",
      "acceptanceCriteria": [
        "validate_data catches invalid employee_id patterns",
        "validate_data catches duplicate employee_ids",
        "validate_data catches invalid dept values",
        "validate_data catches amount out of range (<=0 or >100000)",
        "validate_data catches invalid currency values",
        "validate_data catches invalid spend_date format and future dates",
        "validate_data catches empty vendor",
        "validate_data catches missing fx_rate for non-USD currencies",
        "validate_data catches fx_rate out of range [0.1, 500]",
        "validate_data sets validation_complete=True",
        "request_user_fix appends to pending_fixes and sets WAITING_FOR_USER",
        "write_fix updates the record value and removes from pending_fixes",
        "write_fix sets status='RUNNING' when pending_fixes is empty",
        "Test: validate_data with clean data returns success",
        "Test: validate_data with errors returns error_count and error details",
        "Test: write_fix corrects a value and verify re-validation passes"
      ],
      "qualityCheck": "cd validator-agent && pytest tests/tools/test_validation.py -v"
    },
    {
      "id": "2.3",
      "title": "Processing tools: transform_data, package_results",
      "phase": 2,
      "depends_on": [
        "1.2"
      ],
      "spec": "validator-agent/docs/phases/phase-02-tools.md#story-2.3",
      "passes": true,
      "description": "Create app/tools/processing.py. (1) transform_data(tool_context, new_column_name, default_value=None, expression=None) \u2014 adds computed column to all records. Supports static default_value or Python expression evaluated with {'row': row} context. Updates dataframe_records and dataframe_columns. (2) async package_results(tool_context) \u2014 separates records into valid/invalid by validation_errors indices. Creates success.xlsx (valid rows) and errors.xlsx (invalid rows + _errors column). Saves both via tool_context.save_artifact(). Sets state['artifacts'] and status='COMPLETED'.",
      "acceptanceCriteria": [
        "transform_data adds a static column to all records",
        "transform_data adds a computed column using expression",
        "transform_data updates dataframe_columns list",
        "transform_data returns error if no data loaded",
        "package_results creates success.xlsx with valid rows only",
        "package_results creates errors.xlsx with invalid rows and _errors column",
        "package_results saves artifacts via tool_context.save_artifact()",
        "package_results sets state['artifacts'] with artifact names",
        "package_results sets state['status'] = 'COMPLETED'",
        "Test: transform_data with default_value adds column to all rows",
        "Test: transform_data with expression computes correct values",
        "Test: package_results separates valid and invalid rows correctly",
        "Test: package_results artifact bytes are valid Excel files"
      ],
      "qualityCheck": "cd validator-agent && pytest tests/tools/test_processing.py -v"
    },
    {
      "id": "3.1",
      "title": "Sub-agents: IngestionAgent, ValidationAgent, ProcessingAgent",
      "phase": 3,
      "depends_on": [
        "2.1",
        "2.2",
        "2.3"
      ],
      "spec": "validator-agent/docs/phases/phase-03-agent-core.md#story-3.1",
      "passes": true,
      "description": "Create app/agents/ingestion.py with IngestionAgent (LlmAgent, model=gemini-2.0-flash, tools=[request_file_upload, ingest_file, ingest_uploaded_file], output_key='ingestion_result'). Create app/agents/validation.py with ValidationAgent (tools=[validate_data, request_user_fix, write_fix], output_key='validation_result'). No render_a2ui tool on any agent. Create app/agents/processing.py with ProcessingAgent (tools=[transform_data, package_results], output_key='processing_result'). Each has clear instruction text describing their role and workflow. Export from app/agents/__init__.py.",
      "acceptanceCriteria": [
        "IngestionAgent has 3 tools: request_file_upload, ingest_file, ingest_uploaded_file",
        "ValidationAgent has 3 tools: validate_data, request_user_fix, write_fix",
        "ProcessingAgent has 2 tools: transform_data, package_results",
        "No agent has render_a2ui in its tools list",
        "Each agent has model='gemini-2.0-flash'",
        "Each agent has an output_key set",
        "Each agent's instruction describes its workflow clearly",
        "All three agents export from app/agents/__init__.py",
        "Test: each agent object can be instantiated and has correct tool count",
        "Test: no agent has 'render_a2ui' in its tools"
      ],
      "qualityCheck": "cd validator-agent && pytest tests/agents/test_sub_agents.py -v"
    },
    {
      "id": "3.2",
      "title": "Root agent: SpreadsheetValidatorAgent orchestrator",
      "phase": 3,
      "depends_on": [
        "3.1",
        "1.3"
      ],
      "spec": "validator-agent/docs/phases/phase-03-agent-core.md#story-3.2",
      "passes": true,
      "description": "Create app/agents/root_agent.py. Root agent uses Agent (not LlmAgent) with name='SpreadsheetValidatorAgent', model='gemini-2.0-flash', sub_agents=[ingestion_agent, validation_agent, processing_agent]. No tools on root (no render_a2ui). Instruction describes the workflow: after ingestion, immediately transfer to ValidationAgent; after validation with no errors, transfer to ProcessingAgent; with errors, wait for user; after fixes, re-validate. Register callbacks: before_agent_callback=on_before_agent, before_model_callback=before_model_modifier, after_model_callback=after_model_modifier. Create app/agent.py wrapping root_agent in App(root_agent=root_agent, name='spreadsheet_validator'). Create app/__init__.py exporting root_agent.",
      "acceptanceCriteria": [
        "Root agent has name='SpreadsheetValidatorAgent'",
        "Root agent has 3 sub-agents",
        "Root agent has no tools (empty or omitted tools list)",
        "Root agent has before_agent_callback set",
        "Root agent has before_model_callback set",
        "Root agent has after_model_callback set",
        "App wraps root_agent with name='spreadsheet_validator'",
        "app/__init__.py exports root_agent",
        "Instruction contains workflow rules for agent transfers",
        "Test: root_agent.sub_agents has length 3",
        "Test: root_agent.tools is empty or None"
      ],
      "qualityCheck": "cd validator-agent && pytest tests/agents/test_root_agent.py -v"
    },
    {
      "id": "4.1",
      "title": "FastAPI server with AG-UI SSE endpoint and REST endpoints",
      "phase": 4,
      "depends_on": [
        "3.2"
      ],
      "spec": "validator-agent/docs/phases/phase-04-backend-server.md#story-4.1",
      "passes": true,
      "description": "Create app/server.py. Initialize shared InMemorySessionService and InMemoryArtifactService. Create ADKAgent.from_app() wrapping the adk_app with emit_messages_snapshot=True. Mount AG-UI SSE endpoint at /agent via add_adk_fastapi_endpoint(). Add CORS middleware (allow all origins). REST endpoints: GET /health (returns status healthy), POST /run?thread_id (pre-creates session with _ag_ui_thread_id in state), POST /upload (file upload, saves as ADK artifact, updates session state with uploaded_file), GET /runs (list sessions with lightweight state \u2014 strip heavy keys), GET /runs/{session_id} (full session state), GET /artifacts/{name} (download artifact), POST /feedback (log user feedback). No imports of any monkey-patch modules. No render_a2ui tool anywhere.",
      "acceptanceCriteria": [
        "GET /health returns {'status': 'healthy'}",
        "POST /run creates a session with _ag_ui_thread_id in state",
        "POST /upload saves file as ADK artifact and sets state['uploaded_file']",
        "POST /upload rejects non-csv/xlsx files with 400",
        "GET /runs returns sessions without heavy row-array keys",
        "GET /runs/{id} returns full session state",
        "GET /runs/{id} returns 404 for non-existent session",
        "GET /artifacts/{name} returns artifact bytes with correct MIME type",
        "POST /feedback records feedback and returns 201",
        "/agent endpoint exists (AG-UI SSE)",
        "No monkey-patch modules imported",
        "Test: health endpoint returns 200",
        "Test: upload endpoint stores artifact and updates session state",
        "Test: runs endpoint strips heavy keys"
      ],
      "qualityCheck": "cd validator-agent && pytest tests/server/test_server.py -v"
    },
    {
      "id": "5.1",
      "title": "Webapp scaffold with Next.js, CopilotKit, and dependencies",
      "phase": 5,
      "depends_on": [],
      "spec": "validator-agent/docs/phases/phase-05-frontend-webapp.md#story-5.1",
      "passes": true,
      "description": "Create webapp/ directory. Initialize with Next.js 16, React 19, TypeScript 5. Install dependencies: @copilotkit/react-core@~1.50, @copilotkit/react-ui@~1.50, @copilotkit/runtime@~1.50, @ag-ui/client@^0.0.42, hono@^4.6.18, lucide-react, clsx, tailwind-merge. Do NOT install @copilotkit/a2ui-renderer or @a2ui/lit \u2014 not used in Plan A. Configure Tailwind CSS 4. Create src/app/layout.tsx with dark theme, geist fonts, Providers wrapper. Create tsconfig.json with path alias @/ -> src/.",
      "acceptanceCriteria": [
        "npm install succeeds",
        "npm run build succeeds (or next build)",
        "package.json has @copilotkit/react-core, @copilotkit/runtime, @ag-ui/client, hono",
        "package.json does NOT have @copilotkit/a2ui-renderer",
        "package.json does NOT have @a2ui/lit",
        "layout.tsx renders children wrapped in Providers",
        "Tailwind CSS classes compile correctly"
      ],
      "qualityCheck": "cd webapp && npm install && npm run build"
    },
    {
      "id": "5.2",
      "title": "AgentState types and CopilotKit Providers (no A2UI renderer)",
      "phase": 5,
      "depends_on": [
        "5.1"
      ],
      "spec": "validator-agent/docs/phases/phase-05-frontend-webapp.md#story-5.2",
      "passes": true,
      "description": "Create src/lib/types.ts with AgentState type matching backend PipelineState exactly. PipelineStatus union includes all 10 values. ValidationError and FixRequest types for nested objects. DEFAULT_INITIAL_STATE constant. Create src/app/Providers.tsx with CopilotKitProvider \u2014 runtimeUrl='/api/copilotkit', NO renderActivityMessages prop (no A2UI renderer). Just wraps children.",
      "acceptanceCriteria": [
        "AgentState type has all fields matching PipelineState",
        "PipelineStatus includes IDLE, RUNNING, VALIDATING, WAITING_FOR_USER, FIXING, TRANSFORMING, PACKAGING, COMPLETED, FAILED",
        "DEFAULT_INITIAL_STATE has status='IDLE', empty arrays, default values",
        "CopilotKitProvider has runtimeUrl='/api/copilotkit'",
        "CopilotKitProvider does NOT have renderActivityMessages prop",
        "Test: DEFAULT_INITIAL_STATE has all required fields with correct defaults"
      ],
      "qualityCheck": "cd webapp && npx vitest run"
    },
    {
      "id": "5.3",
      "title": "CopilotKit API route with HttpAgent",
      "phase": 5,
      "depends_on": [
        "5.1"
      ],
      "spec": "validator-agent/docs/phases/phase-05-frontend-webapp.md#story-5.3",
      "passes": true,
      "description": "Create src/app/api/copilotkit/[[...handle]]/route.ts. Use CopilotRuntime from @copilotkit/runtime/v2 with HttpAgent from @ag-ui/client pointing to the backend /agent endpoint (configurable via NEXT_PUBLIC_AGENT_URL env var, default http://localhost:8080/agent). Use createCopilotEndpoint with hono/vercel handle. Export GET and POST handlers. The agent key should be 'spreadsheet_validator' to match the backend ADK app name.",
      "acceptanceCriteria": [
        "route.ts exports GET and POST handlers",
        "CopilotRuntime has agent keyed as 'spreadsheet_validator'",
        "HttpAgent URL defaults to http://localhost:8080/agent",
        "HttpAgent URL is configurable via NEXT_PUBLIC_AGENT_URL",
        "Uses hono/vercel handle for request processing"
      ],
      "qualityCheck": "cd webapp && npm run build"
    },
    {
      "id": "5.4",
      "title": "Custom React card components for pipeline states",
      "phase": 5,
      "depends_on": [
        "5.2"
      ],
      "spec": "validator-agent/docs/phases/phase-05-frontend-webapp.md#story-5.4",
      "passes": true,
      "description": "Create src/components/a2ui/ directory (name retained for organizational consistency). (1) IngestionSummaryCard.tsx \u2014 props: fileName, rowCount, columnCount, columns. Shows file icon, name, stats. (2) ValidationResultsCard.tsx \u2014 props: totalRows, validCount, errorCount. Shows green/red progress bar, counts. (3) ProgressCard.tsx \u2014 props: phaseName, progress?. Shows spinner and phase label. (4) CompletionCard.tsx \u2014 props: totalRows, validCount, errorCount, fixedCount, artifactNames. Shows success checkmark, summary stats, artifact download links. Each card uses Tailwind for dark theme styling with rounded borders and appropriate colors.",
      "acceptanceCriteria": [
        "IngestionSummaryCard renders file name, row count, column count, and column list",
        "ValidationResultsCard renders total rows, valid count, error count with progress bar",
        "ProgressCard renders spinner animation and phase name",
        "CompletionCard renders success icon, summary stats, and artifact names",
        "All cards use Tailwind dark theme styling",
        "Test: IngestionSummaryCard renders all props correctly",
        "Test: ValidationResultsCard calculates progress bar width correctly",
        "Test: CompletionCard renders artifact download links"
      ],
      "qualityCheck": "cd webapp && npx vitest run"
    },
    {
      "id": "5.5",
      "title": "useCoAgentStateRender hook for state-driven card rendering",
      "phase": 5,
      "depends_on": [
        "5.4",
        "5.2"
      ],
      "spec": "validator-agent/docs/phases/phase-05-frontend-webapp.md#story-5.5",
      "passes": true,
      "description": "Create src/hooks/useA2UIStateRender.ts. Uses useCoAgentStateRender<AgentState> from @copilotkit/react-core with name='spreadsheet_validator'. Render function checks state.status and returns appropriate component: COMPLETED->CompletionCard, TRANSFORMING/PACKAGING->ProgressCard, VALIDATING/FIXING/WAITING_FOR_USER with data->ValidationResultsCard, RUNNING with data->IngestionSummaryCard. Derives counts from array lengths (totalRows=dataframe_records.length, errorCount=validation_errors.length). Returns null when no card applies.",
      "acceptanceCriteria": [
        "Hook calls useCoAgentStateRender with name='spreadsheet_validator'",
        "COMPLETED status renders CompletionCard with correct props",
        "TRANSFORMING/PACKAGING status renders ProgressCard",
        "VALIDATING status with data renders ValidationResultsCard",
        "RUNNING status with loaded data renders IngestionSummaryCard",
        "Counts are derived from array lengths, not hardcoded",
        "Returns null when state has no data (initial IDLE)",
        "Test: hook returns CompletionCard when status is COMPLETED",
        "Test: hook returns IngestionSummaryCard when status is RUNNING with data",
        "Test: hook returns null when status is IDLE with no data"
      ],
      "qualityCheck": "cd webapp && npx vitest run"
    },
    {
      "id": "5.6",
      "title": "Main page with file upload, chat, and state rendering",
      "phase": 5,
      "depends_on": [
        "5.5",
        "5.3"
      ],
      "spec": "validator-agent/docs/phases/phase-05-frontend-webapp.md#story-5.6",
      "passes": true,
      "description": "Create src/app/page.tsx as client component. Generates threadId via useMemo(crypto.randomUUID). Manages file upload via hidden input + button. Upload handler: creates FormData, POSTs to backend /upload?thread_id=X, on success triggers agent via copilotkit.runAgent() with a message containing the file name. Calls useA2UIStateRender() to activate card rendering. Renders CopilotChat with agentId='spreadsheet_validator', threadId, file upload button in input area, and placeholder text. Status bar at top shows upload progress.",
      "acceptanceCriteria": [
        "Page renders CopilotChat with agentId='spreadsheet_validator'",
        "threadId is generated once on mount via crypto.randomUUID()",
        "File input accepts .csv, .xlsx, .xls",
        "Upload POSTs to backend /upload with thread_id query param",
        "On successful upload, agent is triggered with file name message",
        "useA2UIStateRender() is called inside the component",
        "Upload status shown during upload",
        "Test: file upload triggers POST to /upload",
        "Test: successful upload sends message to agent"
      ],
      "qualityCheck": "cd webapp && npm run build"
    },
    {
      "id": "6.1",
      "title": "End-to-end integration test: upload to completion",
      "phase": 6,
      "depends_on": [
        "4.1",
        "5.6"
      ],
      "spec": "validator-agent/docs/phases/phase-06-integration-quality.md#story-6.1",
      "passes": false,
      "description": "Create tests/e2e/test_full_pipeline.py. Uses httpx AsyncClient with the FastAPI app. Steps: (1) POST /run to create session. (2) POST /upload with a test CSV containing both valid and invalid rows. (3) Verify session state has uploaded_file set. (4) Verify the ADK agent can process the session (this may require a mock or live Gemini call \u2014 use pytest.mark.skipif for CI). For unit-testable verification: call tools directly in sequence: ingest_uploaded_file, validate_data, transform_data, package_results. Verify final state: status=COMPLETED, artifacts has success.xlsx and errors.xlsx, validation_errors populated. Verify artifacts are downloadable via GET /artifacts/success.xlsx.",
      "acceptanceCriteria": [
        "Test creates session via POST /run",
        "Test uploads CSV via POST /upload",
        "Test verifies session state has uploaded_file set",
        "Test calls tools in sequence: ingest -> validate -> transform -> package",
        "Test verifies final status is COMPLETED",
        "Test verifies artifacts dict has success.xlsx and errors.xlsx",
        "Test verifies GET /artifacts/success.xlsx returns valid Excel bytes",
        "Test verifies validation_errors are populated for invalid rows",
        "All tests pass with pytest"
      ],
      "qualityCheck": "cd validator-agent && pytest tests/e2e/ -v"
    },
    {
      "id": "6.2",
      "title": "Frontend build verification and lint",
      "phase": 6,
      "depends_on": [
        "5.6"
      ],
      "spec": "validator-agent/docs/phases/phase-06-integration-quality.md#story-6.2",
      "passes": false,
      "description": "Run npm run build to verify Next.js compiles without errors. Run npm run lint (eslint) to verify no lint issues. Run ruff check . and ruff format --check . on the backend. Fix any issues found. Verify no TypeScript errors in strict mode.",
      "acceptanceCriteria": [
        "npm run build succeeds with exit code 0",
        "npm run lint succeeds with no errors",
        "ruff check . passes on backend code",
        "ruff format --check . passes on backend code",
        "No TypeScript strict mode errors"
      ],
      "qualityCheck": "cd validator-agent && ruff check . && ruff format --check . && cd ../webapp && npm run build && npm run lint"
    }
  ],
  "phases": {
    "1": {
      "title": "Project Scaffold & Models",
      "focus": "Python package structure, PipelineState model, agent callbacks"
    },
    "2": {
      "title": "Tools",
      "focus": "Ingestion tools (file upload, CSV/XLSX reading), validation tools (7 rules, fix lifecycle), processing tools (transform, package Excel)"
    },
    "3": {
      "title": "Agent Core",
      "focus": "Three sub-agents with tool assignments, root orchestrator with callbacks and workflow rules"
    },
    "4": {
      "title": "Backend Server",
      "focus": "FastAPI with AG-UI SSE endpoint, REST endpoints for upload/runs/artifacts/health, no monkey-patches"
    },
    "5": {
      "title": "Frontend Webapp",
      "focus": "Next.js + CopilotKit + HttpAgent. Custom React card components. useCoAgentStateRender hook for state-driven rendering. File upload page."
    },
    "6": {
      "title": "Integration & Quality",
      "focus": "End-to-end pipeline test, frontend build verification, lint"
    }
  }
}
